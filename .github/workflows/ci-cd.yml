name: Flexible Full Stack JS CI/CD Pipeline

on:
  push:
    branches: [ main, dev, 'feature/**' ]
  pull_request:
    branches: [ main, dev ]

jobs:
  #=================================================================
  # JOB 1: Backend CI (Runs only if backend/package.json exists)
  #=================================================================
  backend-ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    
    defaults:
      run:
        working-directory: ./backend
        
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Check if backend folder exists
        id: check_backend_exists
        working-directory: ./
        run: |
          if [ -f "backend/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Backend found. Running backend CI..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No backend/package.json found. Skipping backend CI."
          fi
        shell: bash

      - name: ğŸŸ¢ Set up Node.js
        if: steps.check_backend_exists.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: ğŸ“¦ Cache NPM Dependencies
        if: steps.check_backend_exists.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-backend-${{ hashFiles('**/backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-backend-
            
      - name: âš™ï¸ Install Dependencies
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm ci

      - name: ğŸ”§ Generate Prisma Client
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npx prisma generate

      - name: ğŸ” Run ESLint
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm run lint -- --format=checkstyle --output-file=eslint-report.xml
        continue-on-error: true

      - name: ğŸ§ª Run Unit Tests
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm run test:unit
      
      - name: ğŸ”— Run Integration Tests
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm run test:integration
        
      - name: ğŸ–¥ï¸ Run System Tests
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm run test:system
        
      - name: ğŸ“Š Check Code Coverage (â‰¥75%)
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm test -- --coverage
        
      - name: ğŸ”’ Check Dependency Vulnerabilities
        if: steps.check_backend_exists.outputs.exists == 'true'
        run: npm audit --audit-level=high | tee npm-audit-report.txt
        continue-on-error: true

      - name: ğŸ“¤ Upload Backend Reports
        if: steps.check_backend_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: backend-reports
          path: |
            backend/coverage/
            backend/eslint-report.xml
            backend/npm-audit-report.txt
          retention-days: 7
        continue-on-error: true

  #=================================================================
  # JOB 2: Frontend CI (Runs only if frontend/package.json exists)
  #=================================================================
  frontend-ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]

    defaults:
      run:
        working-directory: ./frontend
        
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ” Check if frontend folder exists
        id: check_frontend_exists
        working-directory: ./
        run: |
          if [ -f "frontend/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Frontend found. Running frontend CI..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No frontend/package.json found. Skipping frontend CI."
          fi
        shell: bash
            
      - name: ğŸŸ¢ Set up Node.js
        if: steps.check_frontend_exists.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: ğŸ“¦ Cache NPM Dependencies
        if: steps.check_frontend_exists.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-frontend-${{ hashFiles('**/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-frontend-
            
      - name: âš™ï¸ Install Dependencies
        if: steps.check_frontend_exists.outputs.exists == 'true'
        run: npm ci
      
      - name: ğŸ” Run ESLint
        if: steps.check_frontend_exists.outputs.exists == 'true'
        run: npm run lint -- --format=checkstyle --output-file=eslint-report.xml
        continue-on-error: true
        
      - name: ğŸ§ª Run Tests & Coverage (â‰¥75%)
        if: steps.check_frontend_exists.outputs.exists == 'true'
        run: npm test -- --coverage
        
      - name: ğŸ”’ Check Dependency Vulnerabilities
        if: steps.check_frontend_exists.outputs.exists == 'true'
        run: npm audit --audit-level=high | tee npm-audit-report.txt
        continue-on-error: true
        
      - name: ğŸ—ï¸ Build Frontend
        if: steps.check_frontend_exists.outputs.exists == 'true'
        run: npm run build
        
      - name: ğŸ“¤ Upload Frontend Build & Reports
        if: steps.check_frontend_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-and-reports
          path: |
            frontend/dist/
            frontend/coverage/
            frontend/eslint-report.xml
            frontend/npm-audit-report.txt
          retention-days: 7
        continue-on-error: true

  #=================================================================
  # JOB 3: Package Deployment Artifact (Packages whatever exists)
  #=================================================================
  package-deployment:
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download Backend Reports (if they exist)
        uses: actions/download-artifact@v4
        with:
          name: backend-reports
          path: reports/backend
        continue-on-error: true 
          
      - name: ğŸ“¥ Download Frontend Build & Reports (if they exist)
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-and-reports
          path: reports/frontend-temp
        continue-on-error: true

      - name: ğŸ“¦ Create Deployment Package
        run: |
          mkdir -p deployment-artifact/backend-src
          mkdir -p deployment-artifact/frontend-dist
          mkdir -p deployment-artifact/reports/backend
          mkdir -p deployment-artifact/reports/frontend

          # Check if backend source exists before copying
          if [ -d "backend/src" ]; then
            echo "Packaging backend source..."
            cp -r backend/src/ deployment-artifact/backend-src/
            cp backend/package.json deployment-artifact/backend-package.json
          fi
          
          # Check if built frontend exists before copying
          if [ -d "reports/frontend-temp/dist" ]; then
            echo "Packaging frontend build..."
            cp -r reports/frontend-temp/dist/* deployment-artifact/frontend-dist/
            cp SE_FINAL_1/frontend/package.json deployment-artifact/frontend-package.json
          fi
          
          # Check if backend reports exist before copying
          if [ -d "reports/backend" ]; then
            echo "Packaging backend reports..."
            cp -r reports/backend/* deployment-artifact/reports/backend/
          fi
          
          # Check if frontend reports exist before copying
          if [ -d "reports/frontend-temp/coverage" ]; then
            echo "Packaging frontend reports..."
            mv reports/frontend-temp/coverage deployment-artifact/reports/frontend/
            [ -f "reports/frontend-temp/eslint-report.xml" ] && mv reports/frontend-temp/eslint-report.xml deployment-artifact/reports/frontend/
            [ -f "reports/frontend-temp/npm-audit-report.txt" ] && mv reports/frontend-temp/npm-audit-report.txt deployment-artifact/reports/frontend/
          fi
          
          echo "Copying root files..."
          cp README.md deployment-artifact/ || true
          
          echo "Build Date: $(date)" > deployment-artifact/BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> deployment-artifact/BUILD_INFO.txt

      - name: ğŸ¤ Zip Deployment Artifact
        run: zip -r tutor-booking-deployment-${{ github.run_number }}.zip deployment-artifact/
        
      - name: ğŸ“¤ Upload Final Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tutor-booking-deployment-${{ github.run_number }}
          path: tutor-booking-deployment-${{ github.run_number }}.zip
          retention-days: 90
          
      - name: ğŸ‰ Pipeline Success
        if: success()
        run: echo "âœ… Flexible CI/CD Pipeline Completed!"
