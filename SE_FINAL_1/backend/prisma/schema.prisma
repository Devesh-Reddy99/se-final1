generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// SQLite doesn't support enums, so we use String with validation at application level
// Valid values for role: STUDENT, TUTOR, ADMIN
// Valid values for status: PENDING, CONFIRMED, CANCELLED, COMPLETED
// Valid values for recurrence: NONE, DAILY, WEEKLY, MONTHLY

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   @default("STUDENT") // STUDENT | TUTOR | ADMIN
  avatar    String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tutorProfile     Tutor?
  bookingsAsStudent Booking[] @relation("StudentBookings")
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model Tutor {
  id          String   @id @default(uuid())
  userId      String   @unique
  bio         String?
  subjects    String   // JSON array stored as string - parse in application
  hourlyRate  Float
  experience  Int?     // Years of experience
  education   String?
  rating      Float    @default(0)
  totalReviews Int     @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  slots    Slot[]
  bookings Booking[] @relation("TutorBookings")

  @@index([userId])
  @@index([isActive])
  @@map("tutors")
}

model Slot {
  id          String         @id @default(uuid())
  tutorId     String
  startTime   DateTime
  endTime     DateTime
  duration    Int            // Duration in minutes
  isBooked    Boolean        @default(false)
  recurrence  String         @default("NONE") // NONE | DAILY | WEEKLY | MONTHLY
  recurrenceEnd DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  tutor    Tutor     @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  booking  Booking?

  @@index([tutorId])
  @@index([startTime])
  @@index([isBooked])
  @@map("slots")
}

model Booking {
  id              String        @id @default(uuid())
  slotId          String        @unique
  studentId       String
  tutorId         String
  status          String        @default("CONFIRMED") // PENDING | CONFIRMED | CANCELLED | COMPLETED
  subject         String
  notes           String?
  cancellationReason String?
  reminderSent    Boolean       @default(false)
  rating          Int?          // Rating from 1-5, only for completed bookings
  review          String?       // Optional review text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  slot    Slot  @relation(fields: [slotId], references: [id], onDelete: Cascade)
  student User  @relation("StudentBookings", fields: [studentId], references: [id], onDelete: Cascade)
  tutor   Tutor @relation("TutorBookings", fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([tutorId])
  @@index([status])
  @@index([createdAt])
  @@map("bookings")
}
